---

#############
# Exclusify #
#############

- name: exclusify | Exclusify
  tags: exclusify
  vars:
    root:
      path: "{{ [playbook_dir, '..', '..', '..', 'path', 'exclusify'] | ansible.builtin.path_join | ansible.builtin.realpath }}"
    fixtures:
      - { path: foo, state: touch }
      - { path: bar, state: touch }
    paths:
      - { path: bar, content: bar }
      - { path: baz, content: baz }
    expected:
      - { path: foo, exists: false }
      - { path: bar, exists: true }
      - { path: baz, exists: true }
  block:

    - name: exclusify | Prepare root
      ansible.builtin.file:  # noqa: risky-file-permissions
        path: "{{ item.path }}"
        state: "{{ item.state }}"
      loop:
        - { path: "{{ root.path }}", state: absent }
        - { path: "{{ root.path }}", state: directory }

    - name: exclusify | Prepare fixtures
      ansible.builtin.file:  # noqa: risky-file-permissions
        path: "{{ [root.path, item.path] | ansible.builtin.path_join }}"
        state: "{{ item.state }}"
        src: "{{ item.src | default(omit) }}"
      loop: "{{ fixtures }}"

    - name: exclusify | Converge find
      manala.path.find:
        path: "{{ root.path }}"
        relative: true
      register: found

    - name: exclusify | Converge
      manala.path.path: "{{ item }}"
      loop: "{{ paths
          | manala.path.exclusify(found.paths)
          | manala.path.root(root)
        }}"
      loop_control:
        label: "{{ item | manala.path.label }}"

    - name: exclusify | Stats
      ansible.builtin.stat:
        path: "{{ [root.path, item.path] | ansible.builtin.path_join }}"
      loop: "{{ expected }}"
      register: stats

    - name: exclusify | Verify
      ansible.builtin.assert:
        quiet: true
        that:
          - stats.results[index].stat.exists == expected[index].exists
      loop: "{{ expected }}"
      loop_control:
        index_var: index
