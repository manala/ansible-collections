---

########
# File #
########

- name: file | File
  tags: file
  vars:
    root:
      path: "{{ [playbook_dir, '..', '..', '..', 'path', 'file'] | ansible.builtin.path_join | ansible.builtin.realpath }}"
    fixtures:
      - {path: explicit_present, mode: '0664', content: 'unchanged'}
    paths:
      - {path: explicit_present, state: file, mode: '0644'}
      - {path: explicit_absent, state: file}
      - {path: implicit_content, content: content}
      - {path: implicit_present_content, state: present, content: content}
      - {path: explicit_content, state: file, content: content}
      - {path: implicit_file, file: file}
      - {path: implicit_present_file, state: present, file: file}
      - {path: explicit_file, state: file, file: file}
      - {path: implicit_template, template: template.j2, vars: {content: template}}
      - {path: implicit_present_template, state: present, template: template.j2, vars: {content: template}}
      - {path: explicit_template, state: file, template: template.j2, vars: {content: template}}
    expected:
      - {path: explicit_present, exists: true, mode: '0644', content: 'unchanged'}
      - {path: explicit_absent, exists: true, mode: '0644', content: ''}
      - {path: implicit_content, exists: true, mode: '0644', content: content}
      - {path: implicit_present_content, exists: true, mode: '0644', content: content}
      - {path: explicit_content, exists: true, mode: '0644', content: content}
      - {path: implicit_file, exists: true, mode: '0644', content: file}
      - {path: implicit_present_file, exists: true, mode: '0644', content: file}
      - {path: explicit_file, exists: true, mode: '0644', content: file}
      - {path: implicit_template, exists: true, mode: '0644', content: template}
      - {path: implicit_present_template, exists: true, mode: '0644', content: template}
      - {path: explicit_template, exists: true, mode: '0644', content: template}
  block:

    - name: file | Prepare root
      ansible.builtin.file:  # noqa: risky-file-permissions
        path: "{{ item.path }}"
        state: "{{ item.state }}"
      loop:
        - {path: "{{ root.path }}", state: absent}
        - {path: "{{ root.path }}", state: directory}

    - name: file | Prepare fixtures
      ansible.builtin.copy:  # noqa: risky-file-permissions
        dest: "{{ [root.path, item.path] | ansible.builtin.path_join }}"
        mode: "{{ item.mode }}"
        content: "{{ item.content }}"
      loop: "{{ fixtures }}"

    - name: file | Converge
      vars:
        __path: "{{ item | manala.path.root(root) }}"
      manala.path.path: "{{ __path }}"
      loop: "{{ paths }}"
      loop_control:
        label: "{{ __path | manala.path.label }}"

    - name: file | Stats
      ansible.builtin.stat:
        path: "{{ [root.path, item.path] | ansible.builtin.path_join }}"
      loop: "{{ expected }}"
      register: stats

    - name: file | Contents
      ansible.builtin.slurp:
        path: "{{ [root.path, item.path] | ansible.builtin.path_join }}"
      loop: "{{ expected }}"
      register: contents

    - name: file | Verify
      ansible.builtin.assert:
        quiet: true
        that:
          - stats.results[index].stat.exists == expected[index].exists
          - stats.results[index].stat.mode == expected[index].mode
          - contents.results[index].content | b64decode == expected[index].content
      loop: "{{ expected }}"
      loop_control:
        index_var: index
